var WaveformCreator={init:function(e){this.buffers=e.buffers,this.wrapper=e.container;var t=this;this.appendElements(e);var i=function(i,a,n){var r=t.getPeaks(i);t.drawWave(r,a),e.image&&n+1===t.buffers.length&&(t.toImage(),t.fireEvent("afterDraw"))};this.buffers.forEach(function(e,a){e.filter?t.filterBuffer(e.buffer,e.filter,function(t){i(t,e.fill,a)}):i(e.buffer,e.fill,a)})},appendElements:function(e){this.canvas=document.createElement("canvas"),this.canvas.width=e.width*window.devicePixelRatio,this.canvas.height=e.height*window.devicePixelRatio,this.canvas.style.width=e.width+"px",this.canvas.style.height=e.height+"px",this.wrapper.appendChild(this.canvas),e.image&&(this.image=document.createElement("img"),this.image.width=e.width,this.image.height=e.height,this.wrapper.appendChild(this.image),this.canvas.style.display="none")},clearCanvas:function(){this.canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height)},toImage:function(){var e=this.canvas.toDataURL();this.image.src=e},getPeaks:function(e){for(var t=e,i=this.canvas.width*window.devicePixelRatio,a=t.length/i,n=~~(a/10)||1,r=2,s=[],h=[],l=0;r>l;l++)for(var o=s[l]=[],c=t.getChannelData(l),f=0;i>f;f++){for(var v=~~(f*a),d=~~(v+a),u=c[0],g=c[0],p=v;d>p;p+=n){var w=c[p];w>g&&(g=w),u>w&&(u=w)}o[2*f]=g,o[2*f+1]=u,(0==l||g>h[2*f])&&(h[2*f]=g),(0==l||u<h[2*f+1])&&(h[2*f+1]=u)}return h},drawWave:function(e,t){var i=this.canvas,$=.5/window.devicePixelRatio,a=i.height,n=0,r=a/2,s=~~(e.length/2),h=1/window.devicePixelRatio,l=1;this.waveCc=i.getContext("2d"),this.waveCc.fillStyle=t,this.progressCc&&(this.progressCc.fillStyle=this.params.progressColor),[this.waveCc,this.progressCc].forEach(function(t){if(t){t.beginPath(),t.moveTo($,r+n);for(var i=0;s>i;i++){var a=Math.round(e[2*i]/l*r);t.lineTo(i*h+$,r-a+n)}for(var i=s-1;i>=0;i--){var a=Math.round(e[2*i+1]/l*r);t.lineTo(i*h+$,r-a+n)}t.closePath(),t.fill(),t.fillRect(0,r+n-$,this.width,$)}},this)},filterBuffer:function(e,t,i){var a=t.type,n=t.freq,r=t.q,s=new OfflineAudioContext(2,e.length,e.sampleRate),h=s.createBufferSource();h.buffer=e;var t=s.createBiquadFilter();t.type=a,t.frequency.value=n,t.Q.value=r,h.connect(t),t.connect(s.destination),h.start(0),s.startRendering(),s.oncomplete=function(e){var t=e.renderedBuffer;i(t)}},fireEvent:function(e){if(this.handlers){var t=this.handlers[e],i=Array.prototype.slice.call(arguments,1);t&&t.forEach(function(e){e.apply(null,i)})}},on:function(e,t){this.handlers||(this.handlers={});var i=this.handlers[e];return i||(i=this.handlers[e]=[]),i.push(t),{name:e,callback:t,un:this.un.bind(this,e,t)}},un:function(e,t){if(this.handlers){var i=this.handlers[e];if(i)if(t)for(var a=i.length-1;a>=0;a--)i[a]==t&&i.splice(a,1);else i.length=0}},unAll:function(){this.handlers=null}},context=new AudioContext;